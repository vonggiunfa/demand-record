# 数据库字段迁移指南

本文档描述如何将数据库从使用 `month` 字段迁移到使用 `year_month` 字段，以解决表格查询不到数据的问题。

## 问题背景

系统中存在字段命名不一致的问题：

1. 数据库表 `demand_records` 中使用的是 `month` 字段
2. 文档和部分代码中使用的是 `year_month` 字段

这种不一致导致了表格查询不到对应的数据。我们需要统一使用 `year_month` 字段。

## 迁移步骤

### 1. 备份数据库

迁移前会自动备份数据库，备份文件保存在 `data/backups/` 目录中。

### 2. 执行迁移

运行以下命令执行数据库迁移：

```bash
npm run migrate-db
```

迁移脚本将执行以下操作：

1. 备份现有数据库
2. 创建临时表（使用 `year_month` 字段）
3. 将现有数据复制到临时表（将 `month` 字段值复制到 `year_month` 字段）
4. 删除旧表
5. 重命名临时表为原表名
6. 重建索引和全文搜索（如果启用）

### 3. 修复全文搜索索引（如果描述内容搜索无法工作）

如果迁移后发现通过描述内容进行搜索无法返回结果，可能是全文搜索索引未正确重建。运行以下命令修复：

```bash
npm run repair-fts
```

这个脚本将：
1. 删除并重新创建FTS虚拟表
2. 重新建立所有记录的全文索引
3. 执行测试查询验证索引是否正常工作

### 4. 验证迁移

迁移完成后，可以通过以下方式验证：

1. 刷新浏览器，确认表格能够正常显示数据
2. 尝试查询不同月份的数据
3. 测试搜索功能（包括按需求ID搜索和按描述内容搜索）

## 代码修改

迁移脚本同时更新了以下代码文件：

1. `lib/db.ts` - 更新表结构定义，使用 `year_month` 字段
2. `lib/demandService.ts` - 更新所有查询和更新操作，使用 `year_month` 字段

## 故障排除

如果迁移过程中出现问题：

1. 迁移脚本会自动回滚事务
2. 可以从备份文件恢复数据库
3. 查看命令输出的错误信息，解决后重新运行迁移脚本

### 全文搜索问题

如果执行完迁移后，基本查询功能正常，但按描述内容搜索无法工作，请尝试：

1. 执行 `npm run repair-fts` 修复全文搜索索引
2. 如果修复后仍有问题，检查控制台输出的错误信息

## 恢复备份（如果需要）

如果需要恢复备份，可以：

1. 停止应用服务
2. 从 `data/backups/` 目录找到最近的备份文件
3. 将备份文件复制到 `data/demands.db`
4. 重启应用服务

## 注意事项

- 迁移过程会暂时锁定数据库，请在用户较少或系统维护期间执行
- 迁移完成后，所有新数据将使用 `year_month` 字段存储 