# DemandRecordTable 组件

## 概述

DemandRecordTable 是一个用于记录和管理需求的表格组件，提供简洁的用户界面和完整的功能，帮助用户高效地管理项目需求。组件采用了现代化的 UI 设计，基于 shadcn/ui 组件库实现，专注于需求数据的管理和操作。组件采用模块化设计，便于维护和扩展。

![组件预览](../../assets/images/demand-record-table-preview.png)

## 功能特性

- **数据展示与编辑**：表格形式展示需求记录，选中行后可直接编辑
- **行选择与批量操作**：支持单行/多行选择和批量操作（删除、导出）
- **CSV导入导出**：支持从CSV导入数据和导出数据到CSV
- **数据持久化**：通过API接口保存数据到后端存储
- **年月筛选**：按年月组织和筛选需求记录
- **高级搜索功能**：通过独立对话框支持按需求ID或描述内容搜索，支持跨月份搜索
- **响应式UI**：适配不同屏幕尺寸，表格区域支持滚动
- **选择性编辑**：只有被选中的行才能编辑，非选中行为只读状态
- **文本居中设计**：所有表头、单元格内容均居中显示，保持界面整洁一致
- **单行输入控件**：所有输入字段使用单行输入框，简化用户操作体验
- **未保存变更提示**：切换月份或导入数据时，如有未保存的更改会提示用户

## 组件结构

DemandRecordTable 采用模块化设计，将功能拆分为多个子组件：

```
components/DemandRecordTable/
├── index.tsx              # 主入口文件，组合所有子组件
├── types.ts               # 类型定义
├── DemandTableContext.tsx # 上下文提供者，集中管理状态
├── TableToolbar.tsx       # 表格工具栏（新增、删除、保存按钮等）
├── SearchBar.tsx          # 搜索栏组件
├── TableBody.tsx          # 表格主体
├── CSVHandlers.tsx        # CSV导入导出功能
├── ConfirmDialog.tsx      # 确认对话框
└── SearchDialog.tsx       # 高级搜索对话框
```

### 子组件职责

- **DemandTableContext**：使用React Context API提供中央状态管理和共享功能
- **TableToolbar**：提供表格操作按钮，包括新增、删除、保存等
- **SearchBar**：提供搜索功能，包括高级搜索入口
- **TableBody**：渲染主表格内容，处理行选择和编辑
- **CSVHandlers**：处理CSV文件的导入和导出
- **ConfirmDialog**：提供操作确认对话框
- **SearchDialog**：提供高级搜索对话框

## 数据模型

```typescript
interface DemandRecord {
  id: string;         // 唯一标识
  demandId: string;   // 需求ID（可编辑）
  description: string; // 需求描述（可编辑）
  createdAt: Date;    // 创建时间（自动生成，不可编辑）
}
```

## 使用方法

### 基本使用

```tsx
import DemandRecordTable from '@/components/DemandRecordTable';

function DemandPage() {
  return (
    <div className="container mx-auto">
      <h1 className="text-2xl font-bold mb-4">需求记录管理</h1>
      <DemandRecordTable />
    </div>
  );
}
```

### 注意事项

- 组件初始化时会自动加载当前年月的数据
- 所有编辑操作需要点击"保存"按钮才会持久化到数据库
- 切换月份或导入数据时，如有未保存的更改会有确认提示
- **只有选中的行才能进行编辑操作**，未选中的行显示为只读状态
- 导出CSV支持全部导出或仅导出选中行数据
- 使用高级搜索可查询所有月份的数据

## 用户界面

组件由以下主要部分组成：

1. **工具栏(TableToolbar)**：
   - 新增按钮：添加新的需求记录
   - 删除按钮：删除选中的记录（显示选中计数）
   - 保存按钮：保存当前修改（有更改时高亮显示）
   - 搜索区域：提供高级搜索入口
   - 导入/导出CSV按钮：提供数据导入导出功能

2. **表格区域(TableBody)**：
   - 固定表头：悬浮时保持可见
   - 固定第一列（选择列）：滚动时始终可见
   - 行交互效果：选中状态有背景色区分，hover有背景色区分
   - 最大高度限制：表格区域最大高度为视口的70%，超出部分可滚动
   
3. **高级搜索对话框(SearchDialog)**：
   - 独立的全屏对话框
   - 包含搜索表单和搜索结果表格
   - 可跨月份搜索数据

4. **确认对话框(ConfirmDialog)**：
   - 在有未保存更改时切换月份、搜索或导入数据时显示
   - 用户可选择继续操作（丢弃更改）或取消操作

## 搜索功能

组件提供了两种搜索方式：

1. **简单搜索**：在表格工具栏中直接搜索当前月份的数据
2. **高级搜索**：通过对话框进行跨月份的全数据搜索

### 高级搜索对话框

高级搜索对话框是一个独立的全屏对话框，包含以下元素：

1. **搜索表单区**：
   - 搜索输入框：单行输入框，用于输入搜索关键词，带有清除按钮
   - 搜索类型选择器：下拉选择框，提供"需求ID"和"描述内容"两种搜索模式
   - 搜索按钮：点击执行搜索

2. **搜索结果区**：
   - 结果计数：显示匹配记录总数和当前显示数量
   - 结果表格：只读表格，显示搜索结果
   - 加载更多按钮：当结果较多时，支持分批加载更多结果
   - 无结果提示：当没有匹配结果时显示友好提示

3. **搜索结果表格结构**：
   - 需求ID列：显示需求ID
   - 描述内容列：显示需求描述
   - 所属月份列：从创建日期中提取年月
   - 创建时间列：显示完整的创建时间

### 搜索交互流程

1. **打开高级搜索**：
   - 用户点击搜索栏右侧的"高级搜索"按钮
   - 系统打开高级搜索对话框，焦点自动定位到搜索输入框

2. **执行搜索**：
   - 用户在搜索框中输入关键词
   - 选择搜索类型（需求ID/描述内容）
   - 点击搜索按钮或按回车键触发搜索
   - 系统在对话框内的结果区域显示匹配的记录

3. **搜索结果处理**：
   - 显示匹配记录总数量和当前显示数量
   - 无匹配结果时显示"没有找到匹配的记录"提示
   - 搜索结果按创建时间降序排列
   - 结果表格为只读模式，不支持选择或编辑

4. **分批加载**：
   - 初始只加载前20条匹配记录
   - 如有更多结果，显示"加载更多结果"按钮
   - 用户点击按钮加载下一批结果

5. **关闭搜索**：
   - 用户点击对话框底部的"关闭"按钮或对话框外区域
   - 系统关闭高级搜索对话框

### 搜索逻辑

1. **ID搜索模式**：
   - 对`demandId`字段进行模糊匹配
   - 支持部分匹配（如输入"ABC"会匹配"ABC123"）

2. **描述搜索模式**：
   - 对`description`字段进行全文搜索
   - 不区分大小写
   - 支持多个关键词（空格分隔）的"与"逻辑匹配

3. **搜索状态管理**：
   - 基础搜索状态由中央Context管理
   - 高级搜索对话框内维护额外的本地状态
   - 只有当用户确认搜索时才会更新全局状态

4. **搜索性能优化**：
   - 采用服务端搜索：通过API请求获取跨月份的搜索结果
   - 实现分批加载：当结果数据量较大时，可分批次加载更多结果
   - 本地状态隔离：高级搜索内使用本地状态减少不必要的UI更新

## 表格结构

表格包含以下列：

| 列名 | 描述 | 可编辑 | 备注 |
|-----|-----|-------|-----|
| 选择 | 用于选择行的复选框 | - | 点击可选中/取消选中当前行，固定在左侧 |
| 需求ID | 需求唯一标识 | 是 | 只有选中行可编辑，单行输入框，文本居中 |
| 需求描述 | 需求的详细描述 | 是 | 只有选中行可编辑，单行输入框，文本居中 |
| 创建时间 | 需求创建的时间 | 否 | 自动生成，不可编辑，文本居中显示 |

## 用户交互流程

### 添加新需求
1. 点击"新增"按钮
2. 系统创建新行并自动选中
3. 系统自动生成当前时间作为创建时间
4. 输入需求ID和描述
5. 点击"保存"按钮持久化数据

### 编辑需求
1. 点击行首的复选框选中需要编辑的行
2. 被选中的行会突出显示，且输入字段变为可编辑状态
3. 编辑需求ID或描述（创建时间不可编辑）
4. 点击"保存"按钮保存修改

### 删除需求
1. 点击行首的复选框选中需要删除的行
2. 点击工具栏上的"删除"按钮
3. 系统移除选中的行
4. 点击"保存"按钮持久化变更

### 全选/取消全选
1. 点击表头中的复选框可以全选/取消全选所有行
2. 全选后所有行变为可编辑状态
3. 取消全选后所有行变为只读状态

### 数据导入导出
1. 导出全部：点击"导出CSV"按钮（无选中行时）
2. 导出选中：选中行后点击"导出CSV"按钮（按钮会显示已选数量）
3. 导入：点击"导入CSV"按钮，选择CSV文件上传
4. 导入时如有未保存的修改，会提示是否替换现有数据

### 年月切换
1. 使用年月选择器选择要查看的年月
2. 如有未保存的修改，系统会弹出确认对话框
3. 确认后系统加载所选年月的数据，取消则保持当前状态

### 搜索需求（简单搜索）
1. 在工具栏的搜索框中输入搜索关键词
2. 选择搜索类型（需求ID或描述内容）
3. 点击搜索按钮或按回车键执行搜索
4. 表格显示当前月份中匹配的记录
5. 显示搜索结果状态和返回按钮

### 高级搜索（跨月份）
1. 点击搜索栏右侧的"高级搜索"按钮
2. 在搜索对话框中输入搜索关键词
3. 选择搜索类型（需求ID/描述内容）
4. 点击搜索按钮执行搜索
5. 在搜索结果表格中查看全部月份中匹配的记录
6. 可点击加载更多按钮加载更多结果
7. 点击关闭按钮关闭对话框

## 响应式行为

组件在不同屏幕尺寸下有不同表现：

- **桌面端**：完整显示所有列和控件
- **平板端/移动端**：
  - 工具栏按钮自动换行（通过`flex-wrap`实现）
  - 表格可水平滚动，首列（选择列）保持固定
  - 表格区域有最大高度限制，垂直方向可滚动
  - 高级搜索对话框响应式调整大小，确保在小屏幕上也能良好显示

## 性能优化

- **模块化设计**：将大型组件拆分为多个小型、专注的组件
- **React Context**：使用Context API集中管理状态，避免属性透传
- **回调优化**：使用`useCallback`防止函数重建
- **派生状态**：使用`useMemo`计算派生状态（如是否全选）
- **集合数据结构**：使用`Set`数据结构高效管理选中状态
- **引用缓存**：使用`useRef`缓存DOM引用，避免不必要的重新获取
- **条件渲染**：根据状态有条件地渲染组件，减少不必要的DOM操作
- **状态隔离**：高级搜索对话框使用本地状态，减少全局状态更新
- **懒加载结果**：搜索结果分批加载，减轻初始加载负担

## 状态管理

组件使用React Context API集中管理状态，主要状态包括：

1. **数据状态**：
   - `records`: 当前显示的需求记录数组
   - `currentMonth`: 当前选中的年月
   - `availableMonths`: 可选的年月列表
   - `searchResults`: 搜索结果

2. **UI状态**：
   - `selectedRows`: 选中行的ID集合（Set数据结构）
   - `isLoading`: 是否正在加载数据
   - `isSaving`: 是否正在保存数据
   - `hasChanges`: 是否有未保存的更改
   - `isSearchMode`: 是否处于搜索模式
   - `isSearchLoading`: 是否正在执行搜索
   - `confirmDialogOpen`: 确认对话框是否打开
   - `pendingAction`: 待确认的操作信息

3. **操作方法**：
   - `loadData`: 加载指定月份的数据
   - `saveData`: 保存当前数据
   - `addNewRecord`: 添加新记录
   - `deleteSelectedRecords`: 删除选中记录
   - `handleSearch`: 执行搜索
   - `loadMoreResults`: 加载更多搜索结果

## API交互

组件与以下API接口交互：

- `GET ${API_BASE_PATH}/api/load-data?yearMonth=YYYY-MM` - 加载指定年月的数据
- `POST ${API_BASE_PATH}/api/save-data` - 保存数据
- `GET ${API_BASE_PATH}/api/year-months` - 获取所有可用的年月列表
- `GET ${API_BASE_PATH}/api/search?term=XXX&type=id|description&offset=0&limit=20` - 搜索数据，支持分页

API请求路径中的`API_BASE_PATH`会自动处理前缀，适配不同部署环境。

详细的API文档请参考[服务端API文档](../../server/api/demand-records.md)。

## CSV导入导出

### CSV格式要求
导入的CSV文件需要包含以下列：
- `demandId`: 需求ID
- `description`: 需求描述

导出的CSV文件包含以下列：
- `demandId`: 需求ID
- `description`: 需求描述
- `createdAt`: 创建时间（格式：YYYY-MM-DD HH:mm:ss）

### 导入处理逻辑
1. 解析CSV文件头部，确定必要列的位置
2. 逐行解析CSV内容，创建新的需求记录
3. 为每条记录生成唯一ID和创建时间
4. 如有未保存的更改，提示用户是否确认替换

### 导出处理逻辑
1. 确定要导出的记录（全部或仅选中的）
2. 生成CSV格式的字符串（包含表头和数据行）
3. 创建Blob对象并触发下载
4. 文件命名格式为"需求记录_YYYY-MM.csv"

## 数据库优化

为支持搜索功能，数据库进行了相关优化，详细信息请参考[数据库模式文档](../../database/sqlite-schema.md)。

## 未来改进计划

1. **表格列宽调整**: 允许用户调整列宽以适应不同内容长度
2. **多选过滤**: 根据选中的行实现快速筛选功能
3. **表格排序**: 支持点击表头按列进行排序
4. **批量编辑**: 支持同时编辑多个选中行的相同字段
5. **分页支持**: 当数据量较大时支持分页显示
6. **搜索历史记录**: 记录用户最近的搜索记录，方便快速重复搜索
7. **高级搜索筛选**: 在高级搜索中添加更多筛选条件，如时间范围

## bug修复点：
- 我发现保存、删除操作之后，并没有toast相关提示，请修复；