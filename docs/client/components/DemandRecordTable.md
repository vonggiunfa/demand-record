# DemandRecordTable 组件

## 概述

DemandRecordTable 是一个用于记录和管理需求的表格组件，提供简洁的用户界面和完整的功能，帮助用户高效地管理项目需求。组件采用了现代化的 UI 设计，基于 shadcn/ui 组件库实现，专注于需求数据的管理和操作。

![组件预览](../../assets/images/demand-record-table-preview.png)

## 功能特性

- **数据展示与编辑**：表格形式展示需求记录，选中行后可直接编辑
- **行选择与批量操作**：支持单行/多行选择和批量操作（删除、导出）
- **CSV导入导出**：支持从CSV导入数据和导出数据到CSV
- **数据持久化**：通过API接口保存数据到后端存储
- **年月筛选**：按年月组织和筛选需求记录
- **搜索功能**：支持按需求ID精确搜索和按描述内容模糊搜索
- **响应式UI**：适配不同屏幕尺寸，表格区域支持滚动
- **选择性编辑**：只有被选中的行才能编辑，非选中行为只读状态
- **文本居中设计**：所有表头、单元格内容均居中显示，保持界面整洁一致
- **单行输入控件**：所有输入字段使用单行输入框，简化用户操作体验
- **未保存变更提示**：切换月份或导入数据时，如有未保存的更改会提示用户

## 数据模型

```typescript
interface DemandRecord {
  id: string;         // 唯一标识
  demandId: string;   // 需求ID（可编辑）
  description: string; // 需求描述（可编辑）
  createdAt: Date;    // 创建时间（自动生成，不可编辑）
}
```

## 使用方法

### 基本使用

```tsx
import DemandRecordTable from '@/components/DemandRecordTable';

function DemandPage() {
  return (
    <div className="container mx-auto">
      <h1 className="text-2xl font-bold mb-4">需求记录管理</h1>
      <DemandRecordTable />
    </div>
  );
}
```

### 注意事项

- 组件初始化时会自动加载当前年月的数据
- 所有编辑操作需要点击"保存"按钮才会持久化到数据库
- 切换年月或导入数据时，如有未保存的更改会有确认提示
- **只有选中的行才能进行编辑操作**，未选中的行显示为只读状态
- 导出CSV支持全部导出或仅导出选中行数据

## 用户界面

组件由以下主要部分组成：

1. **工具栏**：
   - 新增按钮：添加新的需求记录
   - 删除按钮：删除选中的记录（显示选中计数）
   - 保存按钮：保存当前修改（有更改时高亮显示）
   - 搜索区域：搜索输入框、类型选择器和按钮
   - 导入CSV按钮：从CSV文件导入数据
   - 导出CSV按钮：导出数据到CSV文件（全部或仅选中的）

2. **年月/搜索状态区域**：
   - 正常模式：显示年月选择器
   - 搜索模式：显示"搜索结果"标签和匹配记录数，提供返回按钮

3. **表格区域**：
   - 固定表头：悬浮时保持可见
   - 固定第一列（选择列）：滚动时始终可见
   - 行交互效果：选中状态有背景色区分，hover有背景色区分，点击行等同于勾选当前行
   - 最大高度限制：表格区域最大高度为视口的70%，超出部分可滚动
   
4. **状态提示**：
   - 操作成功/失败的Toast提示
   - 加载中、保存中状态显示（使用动画图标）
   - 空数据状态提示及添加第一条记录的快捷按钮

5. **确认对话框**：
   - 在有未保存更改时切换月份或导入数据会显示确认对话框
   - 用户可选择继续操作（丢弃更改）或取消操作

## 搜索功能

组件提供强大的搜索功能，帮助用户快速找到所需的需求记录。

### 搜索界面

搜索区域位于工具栏中，包含以下元素：

1. **搜索输入框**：
   - 单行输入框，用于输入搜索关键词
   - 带有清除按钮，可快速清空输入内容
   - 设置适当的宽度，与其他控件保持一致的视觉风格

2. **搜索类型选择器**：
   - 下拉选择框，提供两种搜索模式：
     - "需求ID"：精确匹配需求ID字段
     - "描述内容"：模糊匹配描述字段
   - 默认选择"需求ID"模式

3. **搜索按钮**：
   - 带有搜索图标
   - 点击触发搜索操作
   - 支持在输入框中按回车键触发搜索

4. **搜索状态指示**：
   - 当前搜索条件的可视化提示
   - 显示匹配记录数量（例如："找到3条匹配记录"）
   - 搜索激活时有明确的视觉指示

### 搜索交互流程

1. **基本搜索**：
   - 用户在搜索框中输入关键词
   - 选择搜索类型（需求ID/描述内容）
   - 点击搜索按钮或按回车键触发搜索
   - 表格显示匹配的记录，不受当前选择年月的限制

2. **搜索模式切换**：
   - 当用户执行搜索时，组件进入"搜索模式"
   - 搜索模式下，年月选择器被禁用，显示"搜索结果"状态
   - 表格显示的数据来自全部年月的匹配记录，而非仅限当前月

3. **搜索结果处理**：
   - 显示匹配记录总数量
   - 无匹配结果时显示友好提示
   - 搜索结果按创建时间降序排列
   - 保持行选择状态（如果选中的行被筛选掉，维持其选中状态）

4. **清除搜索**：
   - 点击搜索框中的清除按钮
   - 退出"搜索模式"，重新启用年月选择器
   - 恢复显示当前选中年月的记录

### 搜索逻辑

1. **ID搜索模式**：
   - 对`demandId`字段进行精确匹配
   - 区分大小写
   - 支持部分匹配（如输入"ABC"会匹配"ABC123"）

2. **描述搜索模式**：
   - 对`description`字段进行模糊匹配
   - 不区分大小写
   - 支持多个关键词（空格分隔）的"与"逻辑匹配

3. **搜索状态管理**：
   - 维护`searchTerm`（搜索词）和`searchType`（搜索类型）状态
   - 维护`isSearchMode`状态，表示是否处于搜索模式
   - 搜索模式下显示的数据不受年月限制

4. **搜索性能优化**：
   - 采用服务端搜索：通过API请求获取跨月份的搜索结果
   - 实现分批加载：当结果数据量较大时，可分批次加载更多结果

## 表格结构

表格包含以下列：

| 列名 | 描述 | 可编辑 | 备注 |
|-----|-----|-------|-----|
| 选择 | 用于选择行的复选框 | - | 点击可选中/取消选中当前行，固定在左侧 |
| 需求ID | 需求唯一标识 | 是 | 只有选中行可编辑，单行输入框，文本居中 |
| 需求描述 | 需求的详细描述 | 是 | 只有选中行可编辑，单行输入框，文本居中 |
| 创建时间 | 需求创建的时间 | 否 | 自动生成，不可编辑，文本居中显示 |

## 用户交互流程

### 添加新需求
1. 点击"新增"按钮
2. 系统创建新行并自动选中
3. 系统自动生成当前时间作为创建时间
4. 输入需求ID和描述
5. 点击"保存"按钮持久化数据

### 编辑需求
1. 点击行首的复选框选中需要编辑的行
2. 被选中的行会突出显示，且输入字段变为可编辑状态
3. 编辑需求ID或描述（创建时间不可编辑）
4. 点击"保存"按钮保存修改

### 删除需求
1. 点击行首的复选框选中需要删除的行
2. 点击工具栏上的"删除"按钮
3. 系统移除选中的行
4. 点击"保存"按钮持久化变更

### 全选/取消全选
1. 点击表头中的复选框可以全选/取消全选所有行
2. 全选后所有行变为可编辑状态
3. 取消全选后所有行变为只读状态

### 数据导入导出
1. 导出全部：点击"导出CSV"按钮（无选中行时）
2. 导出选中：选中行后点击"导出CSV"按钮（按钮会显示已选数量）
3. 导入：点击"导入CSV"按钮，选择CSV文件上传
4. 导入时如有未保存的修改，会提示是否替换现有数据

### 年月切换
1. 使用年月选择器选择要查看的年月
2. 如有未保存的修改，系统会弹出确认对话框
3. 确认后系统加载所选年月的数据，取消则保持当前状态

## 响应式行为

组件在不同屏幕尺寸下有不同表现：

- **桌面端**：完整显示所有列和控件
- **平板端/移动端**：
  - 工具栏按钮自动换行（通过`flex-wrap`实现）
  - 表格可水平滚动，首列（选择列）保持固定
  - 表格区域有最大高度限制，垂直方向可滚动

## 性能优化

- **回调优化**：使用`useCallback`防止函数重建
- **派生状态**：使用`useMemo`计算派生状态（如是否全选）
- **集合数据结构**：使用`Set`数据结构高效管理选中状态
- **引用缓存**：使用`useRef`缓存DOM引用，避免不必要的重新获取
- **条件渲染**：根据状态有条件地渲染组件，减少不必要的DOM操作
- **状态管理**：精确控制状态更新，避免不必要的重渲染

## 状态管理

组件内部管理以下状态：

1. **数据状态**：
   - `records`: 当前显示的需求记录数组
   - `currentMonth`: 当前选中的年月
   - `availableMonths`: 可选的年月列表

2. **UI状态**：
   - `selectedRows`: 选中行的ID集合（Set数据结构）
   - `isLoading`: 是否正在加载数据
   - `isSaving`: 是否正在保存数据
   - `hasChanges`: 是否有未保存的更改
   - `confirmDialogOpen`: 确认对话框是否打开
   - `pendingAction`: 待确认的操作信息

## API交互

组件与以下API接口交互：

- `GET ${API_BASE_PATH}/api/load-data?yearMonth=YYYY-MM` - 加载指定年月的数据
- `POST ${API_BASE_PATH}/api/save-data` - 保存数据
- `GET ${API_BASE_PATH}/api/year-months` - 获取所有可用的年月列表
- `GET ${API_BASE_PATH}/api/search?term=XXX&type=id|description` - 跨月份搜索数据

API请求路径中的`API_BASE_PATH`会自动处理前缀，适配不同部署环境。

详细的API文档请参考[服务端API文档](../../server/api/demand-records.md)。

## CSV导入导出

### CSV格式要求
导入的CSV文件需要包含以下列：
- `demandId`: 需求ID
- `description`: 需求描述

导出的CSV文件包含以下列：
- `demandId`: 需求ID
- `description`: 需求描述
- `createdAt`: 创建时间（格式：YYYY-MM-DD HH:mm:ss）

### 导入处理逻辑
1. 解析CSV文件头部，确定必要列的位置
2. 逐行解析CSV内容，创建新的需求记录
3. 为每条记录生成唯一ID和创建时间
4. 如有未保存的更改，提示用户是否确认替换

### 导出处理逻辑
1. 确定要导出的记录（全部或仅选中的）
2. 生成CSV格式的字符串（包含表头和数据行）
3. 创建Blob对象并触发下载
4. 文件命名格式为"需求记录_YYYY-MM.csv"

## 数据库优化

为支持搜索功能，数据库进行了相关优化，详细信息请参考[数据库模式文档](../../database/sqlite-schema.md)。

## 未来改进计划

1. **表格列宽调整**: 允许用户调整列宽以适应不同内容长度
2. **多选过滤**: 根据选中的行实现快速筛选功能
3. **表格排序**: 支持点击表头按列进行排序
4. **批量编辑**: 支持同时编辑多个选中行的相同字段
5. **分页支持**: 当数据量较大时支持分页显示

## bug修复点：
