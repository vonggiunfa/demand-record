# DemandRecordTable 组件

## 概述

DemandRecordTable 是一个用于记录和管理需求的表格组件，提供简洁的用户界面和完整的功能，帮助用户高效地管理项目需求。组件采用了与系统中其他表格组件一致的设计风格，但功能更加专注于需求管理。

![组件预览](../../assets/images/demand-record-table-preview.png)

## 功能特性

- **数据展示与编辑**：表格形式展示和编辑需求记录
- **行选择与批量操作**：支持单行/多行选择和批量操作
- **CSV导入导出**：支持从CSV导入数据和导出数据到CSV
- **数据持久化**：自动保存数据到SQLite数据库
- **年月筛选**：按年月组织和筛选需求记录
- **响应式UI**：适配不同屏幕尺寸
- **键盘导航**：支持键盘快捷操作
- **选择性编辑**：只有被选中的行才能编辑，非选中行为只读状态

## 数据模型

```typescript
interface DemandRecord {
  id: string;         // 唯一标识
  demandId: string;   // 需求ID（可编辑）
  description: string; // 需求描述（可编辑）
  createdAt: Date;    // 创建时间（自动生成，不可编辑）
}
```

## 使用方法

### 基本使用

```tsx
import DemandRecordTable from '@/components/DemandRecordTable';

function DemandPage() {
  return (
    <div className="container mx-auto">
      <h1 className="text-2xl font-bold mb-4">需求记录管理</h1>
      <DemandRecordTable />
    </div>
  );
}
```

### 注意事项

- 组件初始化时会自动加载当前年月的数据
- 所有编辑操作需要点击"保存"按钮才会持久化到数据库
- 切换年月时会提示保存当前数据
- **只有选中的行才能进行编辑操作**，未选中的行显示为只读状态

## 用户界面

组件由以下主要部分组成：

1. **工具栏**：
   - 新增按钮：添加新的需求记录
   - 删除按钮：删除选中的记录（显示选中计数）
   - 保存按钮：保存当前修改到数据库（显示保存状态）
   - 导入CSV按钮：从CSV文件导入数据
   - 导出CSV按钮：导出数据到CSV文件（全部或仅选中的）

2. **年月选择器**：
   - 显示当前选中的年月
   - 点击可打开年月选择弹窗
   - 选择不同年月会自动加载对应数据

3. **表格区域**：
   - 固定表头：悬浮时保持可见
   - 固定第一列（选择列）：滚动时始终可见
   - 行交互效果：悬浮高亮、选中状态样式
   - 自定义滚动条：美观且功能完善
   
4. **状态提示**：
   - 操作成功/失败的Toast提示
   - 加载中、保存中状态显示
   - 空数据状态提示

## 表格结构

表格包含以下列：

| 列名 | 描述 | 可编辑 | 备注 |
|-----|-----|-------|-----|
| 选择 | 用于选择行的复选框 | - | 点击可选中/取消选中当前行 |
| 需求ID | 需求唯一标识 | 是 | 只有选中行可编辑 |
| 需求描述 | 需求的详细描述 | 是 | 只有选中行可编辑 |
| 创建时间 | 需求创建的时间 | 否 | 自动生成，不可编辑 |

## 用户交互流程

### 添加新需求
1. 点击"新增"按钮
2. 系统创建新行并自动选中
3. 系统自动生成当前时间作为创建时间
4. 输入需求ID和描述
5. 点击"保存"按钮持久化数据

### 编辑需求
1. 点击行首的复选框选中需要编辑的行
2. 被选中的行会突出显示，且输入字段变为可编辑状态
3. 编辑需求ID或描述（创建时间不可编辑）
4. 点击"保存"按钮保存修改

### 删除需求
1. 点击行首的复选框选中需要删除的行
2. 点击工具栏上的"删除"按钮
3. 系统移除选中的行
4. 点击"保存"按钮持久化变更

### 全选/取消全选
1. 点击表头中的复选框可以全选/取消全选所有行
2. 全选后所有行变为可编辑状态
3. 取消全选后所有行变为只读状态

### 数据导入导出
1. 导出全部：点击"导出CSV"按钮（无选中行时）
2. 导出选中：点击"导出CSV"按钮（有选中行时）
3. 导入：点击"导入CSV"按钮，选择CSV文件上传
4. 导入时如已有数据，会提示是否替换现有数据

### 年月切换
1. 使用年月选择器选择要查看的年月
2. 如有未保存的修改，系统会提示保存
3. 系统自动加载所选年月的数据

### 键盘导航
1. 在输入框中按 Enter 键可以跳转到下一个输入字段
2. 如果是最后一个字段按 Enter，将循环回该行的第一个字段
3. 使用 Tab 键可以在所有可交互元素间导航

## 响应式行为

组件在不同屏幕尺寸下有不同表现：

- **桌面端**：完整显示所有列和控件
- **平板端**：表格可水平滚动，首列（选择列）保持固定
- **移动端**：
  - 工具栏按钮自动换行
  - 表格可水平滚动，首列（选择列）保持固定
  - 优化触摸操作区域大小

## 性能优化

- **记忆化组件**：使用React.memo减少不必要的重渲染
- **回调优化**：使用useCallback防止函数重建
- **集合数据结构**：使用Set数据结构高效管理选中状态
- **引用缓存**：使用useRef缓存DOM引用，避免不必要的重新获取
- **条件渲染**：根据状态有条件地渲染组件，减少不必要的DOM操作

## 选择与编辑逻辑

1. **选择机制**：
   - 行选择通过Set数据结构管理（selectedRows）
   - 每行的选中状态决定该行是否可编辑
   - 表头复选框根据是否全部选中自动切换状态

2. **编辑机制**：
   - 只有选中的行才能进行编辑操作
   - 未选中的行显示为只读文本
   - 创建时间列始终为只读，不提供编辑控件
   - 编辑操作会立即更新组件状态，但需要点击保存按钮才会持久化到数据库

## API参考

组件不接受任何属性，但内部使用以下API：

- `GET /api/load-data?yearMonth=YYYY-MM` - 加载指定年月的数据
- `POST /api/save-data` - 保存数据
- `GET /api/year-months` - 获取所有可用的年月列表

更多API详情请参考[API文档](../../server/api/demand-records.md)。

## 样式定制

组件使用Tailwind CSS进行样式设置，主要自定义样式类包括：

- `selected`：选中行的样式
- `sticky-left`：固定在左侧的列样式
- `readonly-text`：只读文本样式

## 错误处理

组件内置了以下错误处理机制：

- 加载失败时显示友好的错误提示
- 保存失败时保留当前编辑状态，便于用户修复后重试
- CSV导入失败时提供详细的错误信息

## 相关组件

- [MonthYearPicker](./MonthYearPicker.md) - 年月选择器组件

## Next.js 配置相关说明

DemandRecordTable 组件的正常运行依赖于正确的 Next.js 配置，特别是与 API 路径相关的配置。

### basePath 配置

项目的 `next.config.mjs` 中配置了 `basePath: '/demand-record'`，这会影响组件中的 API 请求路径。组件内部已经做了适配，会自动将 basePath 添加到 API 请求 URL 中：

```typescript
// 组件内部处理 basePath 的示例代码
const basePath = process.env.NEXT_PUBLIC_BASE_PATH || '/demand-record';
const apiUrl = `${basePath}/api/load-data?yearMonth=${yearMonth}`;
```

### 配置注意事项

1. **环境变量**：如果需要在不同环境下使用不同的 basePath，可通过 `NEXT_PUBLIC_BASE_PATH` 环境变量覆盖默认值

2. **API 请求路径**：组件内所有 API 请求都会自动添加 basePath 前缀，包括：
   - 加载数据：`${basePath}/api/load-data`
   - 保存数据：`${basePath}/api/save-data`
   - 获取年月列表：`${basePath}/api/year-months`

3. **部署环境差异**：
   - 开发环境：通常使用默认的 basePath
   - 生产环境：可能需要根据部署路径调整 basePath

4. **路径自动检测**：组件内置了路径检测机制，会在 API 请求失败时尝试不同的路径前缀，以适应不同的部署环境

### 相关配置文件

请参考项目根目录下的 `next.config.mjs` 文件了解完整配置：

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  devIndicators: false,
  basePath: '/demand-record',
}

export default nextConfig
```

组件内部已经做了自适应处理，可以在不同的部署环境中正常工作。如果需要修改 basePath 配置，请确保相应更新组件中使用的默认 basePath 值，以确保 API 请求路径正确。

更多配置详情请参考[Next.js 配置文档](../next-config.md)。 